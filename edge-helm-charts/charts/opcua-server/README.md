# OPC UA Server Helm Chart

## Overview

The OPC UA Server chart deploys a lightweight OPC UA server that exposes
select UNS (Unified Namespace) topics as OPC UA tags. This enables
integration with OPC UA clients such as SCADA systems, historians, and
other industrial software.

## Architecture

The server runs a Node.js application that:
- Connects to the local ACS MQTT broker and subscribes to configured
  UNS topics
- Maintains the latest value for each topic in memory, with a
  persistent cache on a PVC so values survive pod restarts
- Serves values via an OPC UA server on port 4840 (configurable)
- Uses the UNS topic path directly as the OPC UA node hierarchy

## Deployment

### Via ACS Admin UI

1. In `acs-admin`, navigate to an edge cluster
2. Click "New Edge Deployment"
3. Select "OPC UA Server" from the Chart dropdown
4. Configure values (see below)
5. Click "Create"

### Required Values

Provide these in the deployment dialog:

```yaml
local:
  host: "mqtt.namespace.svc.cluster.local"  # Local MQTT broker hostname
topics:
  "UNS/v1/AMRC/#": {}                        # Topic patterns to subscribe to
```

### Optional Values

Override any of the defaults from `values.yaml`:

```yaml
local:
  host: "mqtt.namespace.svc.cluster.local"
  port: 1883                          # Default: 1883
topics:
  "UNS/v1/AMRC/#": {}
  "UNS/v1/Utilities/#": {}             # Multiple topic patterns supported
opcua:
  port: 4840                           # Default: 4840
  username: "customuser"               # Default: "opcua"
nodePort: 30484                        # Optional: fixed NodePort (else random)
limits:
  cpu: "150m"                          # Default: "100m"
  memory: "256Mi"                      # Default: "128Mi"
tolerations:
  specific: []                         # Host-specific tolerations
  floating: []                         # Floating pod tolerations
```

### Automatic Values

These are populated automatically by the ACS deployment system:

- `name` — deployment name (from dialog)
- `uuid` — deployment UUID (generated by ConfigDB)
- `hostname` — target Kubernetes node (from dialog, optional)
- `realm` — Kerberos realm (from cluster config)
- `cluster` — cluster name (from edge-sync environment)
- `authGroup.edgeService` — edge service account class
- `authGroup.unsReader` — OPC UA Server edge role (grants UNS read permissions)

### Value Merge Behavior

Values are merged in this order (last wins):
1. Cluster base values (realm, cluster, directory_url)
2. HelmTemplate defaults (name, uuid, hostname, authGroup)
3. Your provided values (local, topics, opcua, etc.)

## Current Status

✅ **Working Features:**
- KerberosKey creation with proper account setup
- Authentication to local ACS MQTT broker with optional TLS
- Subscription to configured UNS topics (wildcards supported)
- Dynamic OPC UA node creation as new topics arrive
- Sub-millisecond value update propagation (event-driven, not polling)
- OPC UA server with username/password authentication
- Auto-generated OPC UA client password stored in a Secret
- Persistent last-value cache across pod restarts
- NodePort Service for external OPC UA client access
- Configurable topic filters (MQTT wildcard patterns)

⚠️ **Known Limitations:**
- Tags report `null` until a UNS message is received for that topic
- OPC UA client authentication is username/password only (no certificates)
